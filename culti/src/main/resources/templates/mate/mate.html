<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/layout}">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link rel="stylesheet" th:href="@{/css/mate/mate.css}">


  <style>
  
  </style>
</head>

<body>
<div class="mate-page" layout:fragment="content">

  <!-- âœ… Header (React ìŠ¤íƒ€ì¼) -->
  <header class="mate-header">
    <div class="inner">
      <h1 class="mate-title">ë™í–‰ êµ¬í•˜ê¸°</h1>
      <p class="mate-subtitle">í•¨ê»˜ ë¬¸í™”ìƒí™œì„ ì¦ê²¨ìš”</p>
    </div>
  </header>

  <!-- âœ… Filter Tabs -->
  <div class="mate-container mate-tabs-wrap">
    <!-- ê¸°ì¡´ íƒ­ êµ¬ì¡° ìœ ì§€ + ìŠ¤íƒ€ì¼ì€ mate.css/ìœ„ ìŠ¤íƒ€ì¼ë¡œ ì»¤ë²„ -->
    <div class="filter-section">
	      <div class="tabs">
			  <a class="tab-button"
			     th:href="@{/mate/mate(category='all', page=1, size=${paging.size})}"
			     th:classappend="${category == 'all'} ? ' active' : ''">ì „ì²´</a>
			
			  <a class="tab-button"
			     th:href="@{/mate/mate(category='movie', page=1, size=${paging.size})}"
			     th:classappend="${category == 'movie'} ? ' active' : ''">ì˜í™”</a>
			
			  <a class="tab-button"
			     th:href="@{/mate/mate(category='concert', page=1, size=${paging.size})}"
			     th:classappend="${category == 'concert'} ? ' active' : ''">ê³µì—°</a>
			
			  <a class="tab-button"
			     th:href="@{/mate/mate(category='exhibition', page=1, size=${paging.size})}"
			     th:classappend="${category == 'exhibition'} ? ' active' : ''">ì „ì‹œ</a>
			</div>
    </div>
  </div>

  <!-- âœ… Posts / Empty -->
  <main class="mate-container">
    <!-- ë¹„ì–´ìˆì„ ë•Œ -->
    <div class="empty-state" id="emptyState" th:if="${#lists.isEmpty(paging.content)}">
      <div class="empty-icon">
        <i class="fa-regular fa-folder-open" style="color:#94a3b8; font-size:22px;"></i>
      </div>
      <p class="t1">ì•„ì§ ë“±ë¡ëœ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤</p>
      <p class="t2">ì²« ë²ˆì§¸ ë™í–‰ ê²Œì‹œê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
    </div>

    <!-- ì¹´ë“œ ê·¸ë¦¬ë“œ -->
    <div class="posts-grid" th:if="${!#lists.isEmpty(paging.content)}">
      <div class="post-card"
           th:each="p : ${paging.content}"
           th:attr="data-id=${p.postId},
                    data-title=${p.title},
                    data-category=${p.category.name()},
                    data-eventAt=${#temporals.format(p.eventAt,'yyyy-MM-dd HH:mm')},
                    data-location=${p.location},
                    data-maxPeople=${p.maxPeople},
                    data-description=${p.description},
                    data-nickname=${p.writer.nickname},
                    data-email=${p.writer.email}">
        <div class="post-header">
          <h3 class="post-title" th:text="${p.title}">ì œëª©</h3>

          <!-- badge label: MOVIE/CONCERT/EXHIBITION -> movie/concert/exhibition -->
          <span class="badge"
                th:text="${p.category}"
                th:classappend="' badge-' + ${#strings.toLowerCase(p.category.name())}">
          </span>
        </div>

        <div class="post-info">
          <div class="info-row">
            <i class="fa-regular fa-calendar"></i>
            <span th:text="${#temporals.format(p.eventAt, 'yyyy-MM-dd HH:mm')}">ë‚ ì§œ</span>
          </div>

          <div class="info-row">
            <i class="fa-solid fa-location-dot"></i>
            <span th:text="${p.location}">ì¥ì†Œ</span>
          </div>

          <div class="info-row">
            <i class="fa-solid fa-users"></i>
            <span><span th:text="${p.maxPeople}">0</span>ëª…</span>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- âœ… Floating Action Button (React FAB ëŠë‚Œ) -->
  <button class="fab" id="createButton" sec:authorize="isAuthenticated()">
    <i class="fa-solid fa-plus"></i>
  </button>

  <!-- âœ… Create Modal (ê¸°ì¡´ ìœ ì§€) -->
  <div class="modal-overlay" id="createModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">ë™í–‰ êµ¬í•˜ê¸°</h2>
        <button class="close-button" onclick="closeCreateModal()">&times;</button>
      </div>

      <form id="createForm" method="post" th:action="@{/mate/addPost}">
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
        <div class="form-group">
          <label class="form-label" for="title">ì‘í’ˆëª…</label>
          <input type="text" class="form-input" id="title" name="title" placeholder="ì˜ˆ) ë“„: íŒŒíŠ¸2" required>
        </div>

        <div class="form-group">
          <label class="form-label" for="category">ì¹´í…Œê³ ë¦¬</label>
          <select class="form-select" id="category" name="category" required>
            <option value="MOVIE">ì˜í™”</option>
            <option value="CONCERT">ê³µì—°</option>
            <option value="EXHIBITION">ì „ì‹œ</option>
          </select>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="date">ë‚ ì§œ</label>
            <input type="date" class="form-input" id="date" name="date" required>
          </div>
          <div class="form-group">
            <label class="form-label" for="time">ì‹œê°„</label>
            <input type="time" class="form-input" id="time" name="time" required>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="location">ì¥ì†Œ</label>
          <input type="text" class="form-input" id="location" name="location" placeholder="ì˜ˆ) CGV ê°•ë‚¨" required>
        </div>

        <div class="form-group">
          <label class="form-label" for="maxPeople">ëª¨ì§‘ ì¸ì›</label>
          <select class="form-select" id="maxPeople" name="maxPeople" required>
            <option value="2">2ëª…</option>
            <option value="3">3ëª…</option>
            <option value="4">4ëª…</option>
            <option value="5">5ëª…</option>
            <option value="6">6ëª…</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label" for="description">ìƒì„¸ ì„¤ëª…</label>
          <textarea class="form-textarea" id="description" name="description"
                    placeholder="í•¨ê»˜ ë³´ê³  ì‹¶ì€ ì´ìœ , ì„ í˜¸í•˜ëŠ” ë¶„ìœ„ê¸° ë“±ì„ ììœ ë¡­ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”" required></textarea>
        </div>

        <div class="button-group">
          <button type="button" class="button button-secondary" onclick="closeCreateModal()">ì·¨ì†Œ</button>
          <button type="submit" class="button button-primary">ë“±ë¡í•˜ê¸°</button>
        </div>
      </form>
    </div>
  </div>

  <!-- âœ… Detail Modal -->
  <div class="modal-overlay" id="detailModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="detailTitle"></h2>
        <button class="close-button" onclick="closeDetailModal()">&times;</button>
      </div>
      <div id="detailContent"></div>
    </div>
  </div>

  <!-- âœ… Apply Modal -->
  <div class="modal-overlay" id="applyModal">
    <div class="modal apply-modal">
      <div class="modal-header">
        <h2 class="modal-title">ì°¸ì—¬ ì‹ ì²­</h2>
        <button class="close-button" onclick="closeApplyModal()">&times;</button>
      </div>

      <div class="form-group">
        <label class="form-label">ì‘ì„±ìì—ê²Œ ì „ë‹¬í•  ë©”ì‹œì§€</label>
        <textarea class="form-textarea apply-textarea" id="applyMessage"
                  placeholder="ìê¸°ì†Œê°œë‚˜ í•¨ê»˜ ë³´ê³  ì‹¶ì€ ì´ìœ ë¥¼ ì ì–´ì£¼ì„¸ìš” ğŸ˜Š"></textarea>
      </div>

      <div class="apply-actions">
        <button class="button button-secondary" onclick="closeApplyModal()">ì·¨ì†Œ</button>
        <button class="button button-primary" onclick="submitApply()">ì‹ ì²­í•˜ê¸°</button>
      </div>
    </div>
  </div>
  
  <form id="applyForm" method="post" action="/mate/applyPost" style="display:none;">
	  <input type="hidden" name="postId" id="applyPostId">
	  <input type="hidden" name="message" id="applyMessageField">
	  <input type="hidden" name="" id="applyCsrfField">
	</form>
  
  <!-- âœ… Delete Confirm Modal -->
<div class="modal-overlay" id="deleteConfirmModal">
  <div class="modal">
    <div class="modal-header">
      <h2 class="modal-title">ê²Œì‹œê¸€ ì‚­ì œ</h2>
      <button class="close-button" onclick="closeDeleteConfirmModal()">&times;</button>
    </div>

    <div style="padding: 6px 0 18px;">
      <p style="margin:0; color:#334155;">ì •ë§ ì‚­ì œí• ê¹Œìš”? ì‚­ì œí•˜ë©´ ë³µêµ¬í•  ìˆ˜ ì—†ì–´ìš”.</p>
    </div>

    <div class="button-group">
      <button type="button" class="button button-secondary" onclick="closeDeleteConfirmModal()">ì·¨ì†Œ</button>

      <!-- ì‹¤ì œ ì‚­ì œ submitìš© form -->
      <form id="deleteForm" method="post" action="/mate/deletePost" style="margin:0;">
        <input type="hidden" name="postId" id="deletePostId">
        <input type="hidden" name="" id="deleteCsrfField">
        <button type="submit" class="button button-danger">ì‚­ì œ</button>
      </form>
    </div>
  </div>
</div>
  

  <!-- âœ… Pagination -->
<div class="pagination-wrap">
  <nav class="pagination" th:if="${paging.totalPages > 1}">

    <!-- ì´ì „ -->
    <a class="page-btn"
       th:if="${paging.hasPrevious()}"
       th:href="@{/mate/mate(category=${category}, page=${paging.number}, size=${paging.size})}">
      â€¹
    </a>

    <!-- í˜ì´ì§€ ë²ˆí˜¸ -->
    <a class="page-num"
       th:each="i : ${#numbers.sequence(1, paging.totalPages)}"
       th:href="@{/mate/mate(category=${category}, page=${i}, size=${paging.size})}"
       th:text="${i}"
       th:classappend="${i == paging.number + 1} ? ' active' : ''">
    </a>

    <!-- ë‹¤ìŒ -->
    <a class="page-btn"
       th:if="${paging.hasNext()}"
       th:href="@{/mate/mate(category=${category}, page=${paging.number + 2}, size=${paging.size})}">
      â€º
    </a>

  </nav>
</div>

  <!-- âœ… JS: ë¡œê·¸ì¸ ì—¬ë¶€ëŠ” ì„œë²„ì—ì„œ ë‚´ë ¤ì£¼ê¸° -->
  <script th:inline="javascript">
    const isAuthenticated = /*[[${#authorization.expression('isAuthenticated()')}]]*/ false;
  </script>
	
<script th:inline="javascript">
  const loginUserEmail = /*[[${user != null ? user.email : ''}]]*/ '';
</script>

<script th:inline="javascript">
  const csrfParam = /*[[${_csrf.parameterName}]]*/ '_csrf';
  const csrfToken = /*[[${_csrf.token}]]*/ '';
</script>

<script th:inline="javascript">
  // ë‚´ê°€ ì´ë¯¸ ì‹ ì²­í•œ ê²Œì‹œê¸€ë“¤ì˜ postId ëª©ë¡ (ì˜ˆ: [1,3,7])
  const appliedPostIds = /*[[${appliedPostIds}]]*/ [];
</script>

  <script>

  let selectedPostId = null;
    // âœ… Detail modal open
    document.querySelectorAll('.post-card').forEach(card => {
    	card.addEventListener('click', () => {
    		selectedPostId = card.dataset.id;
    	    const title = card.dataset.title || '';
    	    const category = card.dataset.category || '';
    	    const eventAt = card.dataset.eventat || '';
    	    const location = card.dataset.location || '';
    	    const maxPeople = card.dataset.maxpeople || '';
    	    const nickname = card.dataset.nickname || '';
    	    const desc = card.dataset.description || '';

    	    // âœ… writerEmail ë¨¼ì €!
    	    const writerEmail = card.dataset.email || '';

    	    document.getElementById('detailTitle').innerHTML =
    	      `${title} <span class="badge badge-${category.toLowerCase()}" style="margin-left:12px;">${category}</span>`;

    	      const isAlreadyApplied = Array.isArray(appliedPostIds) && appliedPostIds.includes(Number(selectedPostId));
    	      
    	    // âœ… ì°¸ì—¬ ë²„íŠ¼
    	    let applyButtonHtml = '';
    	    if (loginUserEmail && loginUserEmail === writerEmail) {
    	    	applyButtonHtml = `
    	    		  <div class="owner-hint">
    	    		    <i class="fa-solid fa-circle-info"></i>
    	    		    <span>ë‚´ê°€ ì‘ì„±í•œ ê²Œì‹œê¸€ì…ë‹ˆë‹¤</span>
    	    		  </div>
    	    		`;
    	    } else if (isAlreadyApplied) {
    	    	  // âœ… ì´ë¯¸ ì‹ ì²­í•œ ê²½ìš°: ë²„íŠ¼ ìˆ¨ê¸°ê±°ë‚˜ ì•ˆë‚´ ë¬¸êµ¬ë¡œ ëŒ€ì²´
    	    	  applyButtonHtml = `
    	    	    <div class="owner-hint">
    	    	      <i class="fa-solid fa-circle-check"></i>
    	    	      <span>ì´ë¯¸ ì‹ ì²­í•œ ê²Œì‹œê¸€ì…ë‹ˆë‹¤</span>
    	    	    </div>
    	    	  `;
    	    } else {
    	      applyButtonHtml = isAuthenticated
    	        ? `<button class="button button-primary" onclick="openApplyModal()">ì°¸ì—¬ ì‹ ì²­</button>`
    	        : `<button class="button button-primary" onclick="location.href='/auth/login'">ë¡œê·¸ì¸ í›„ ì‹ ì²­</button>`;
    	    }

    	    // âœ… ì‚­ì œ ë²„íŠ¼
    	    let deleteButtonHtml = '';
    	    if (loginUserEmail && loginUserEmail === writerEmail) {
    	      deleteButtonHtml = `
    	        <button type="button" class="button button-danger"
    	                onclick="openDeleteConfirmModal(${card.dataset.id})">
    	          ì‚­ì œ
    	        </button>
    	      `;
    	    }
    	    
    	    const hasApply = applyButtonHtml && applyButtonHtml.trim().length > 0;
    	    const hasDelete = deleteButtonHtml && deleteButtonHtml.trim().length > 0;
    	    const actionClass = (!hasApply || !hasDelete) ? 'detail-actions only-one' : 'detail-actions';

    	    document.getElementById('detailContent').innerHTML = `
    	      <div class="detail-grid">
    	        <div class="detail-item"><i class="fa-solid fa-user"></i>
    	          <div class="detail-content"><div class="detail-value">${nickname}</div></div>
    	        </div>
    	        <div class="detail-item"><i class="fa-regular fa-calendar detail-fa"></i>
    	          <div class="detail-content"><div class="detail-label">ë‚ ì§œ ë° ì‹œê°„</div><div class="detail-value">${eventAt}</div></div>
    	        </div>
    	        <div class="detail-item"><i class="fa-solid fa-location-dot detail-fa"></i>
    	          <div class="detail-content"><div class="detail-label">ì¥ì†Œ</div><div class="detail-value">${location}</div></div>
    	        </div>
    	        <div class="detail-item"><i class="fa-solid fa-users detail-fa"></i>
    	          <div class="detail-content"><div class="detail-label">ëª¨ì§‘ ì¸ì›</div><div class="detail-value">${maxPeople}ëª…</div></div>
    	        </div>
    	      </div>

    	      <div class="detail-description">
    	        <div class="detail-label">ìƒì„¸ ì„¤ëª…</div>
    	        <p class="description-text">${desc}</p>
    	      </div>

    	      <div class="button-group">
    	        ${applyButtonHtml}
    	      </div>
    	      <div class="${actionClass}">
    	        ${deleteButtonHtml}
    	      </div>
    	    `;

    	    document.getElementById('detailModal').classList.add('show');
    	  });
    	});

    function closeDetailModal() {
      document.getElementById('detailModal').classList.remove('show');
    }

    function openApplyModal() {
    	  document.getElementById('applyMessage').value = '';
    	  document.getElementById('applyModal').classList.add('show');
    	}

    function closeApplyModal() {
      document.getElementById('applyModal').classList.remove('show');
    }

    function submitApply() {
    	  const message = document.getElementById('applyMessage').value.trim();

    	  if (!selectedPostId) {
    	    alert("ê²Œì‹œê¸€ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.");
    	    return;
    	  }

    	  if (!message) {
    	    alert("ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    	    return;
    	  }

    	  // form ê°’ ì±„ìš°ê¸°
    	  document.getElementById('applyPostId').value = selectedPostId;
    	  document.getElementById('applyMessageField').value = message;

    	  // CSRF ë„£ê¸°
    	  const csrfInput = document.getElementById('applyCsrfField');
    	  csrfInput.setAttribute('name', csrfParam);
    	  csrfInput.value = csrfToken;

    	  // ì œì¶œ
    	  document.getElementById('applyForm').submit();
    	}

    // âœ… Create modal open
    const createBtn = document.getElementById('createButton');
    if (createBtn) {
      createBtn.addEventListener('click', () => {
        document.getElementById('createModal').classList.add('show');
      });
    }

    function closeCreateModal() {
      document.getElementById('createModal').classList.remove('show');
      document.getElementById('createForm').reset();
    }

    // âœ… overlay click close
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) overlay.classList.remove('show');
      });
    });

    
    function openDeleteConfirmModal(postId) {
    	  // hidden ê°’ ì„¸íŒ…
    	  document.getElementById('deletePostId').value = postId;

    	  // CSRF hidden field ì„¸íŒ… (name ë™ì ìœ¼ë¡œ ë„£ê¸°)
    	  const csrfInput = document.getElementById('deleteCsrfField');
    	  csrfInput.setAttribute('name', csrfParam);
    	  csrfInput.value = csrfToken;

    	  // ëª¨ë‹¬ ì—´ê¸°
    	  document.getElementById('deleteConfirmModal').classList.add('show');
    	}

    	function closeDeleteConfirmModal() {
    	  document.getElementById('deleteConfirmModal').classList.remove('show');
    	}
  </script>

</div>
</body>
</html>