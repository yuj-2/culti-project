<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>리뷰 전체보기</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script th:src="@{/js/review/review.js}"></script>
    <style>
        .text-primary { color: #503396; }
        .bg-primary { background-color: #503396; }
        .border-primary { border-color: #503396; }
        .text-secondary { color: #252451; }
    </style>
</head>
<body class="bg-[#F9FAFB] min-h-screen">
    
    <div th:replace="~{layout/header :: headerFragment}"></div>
    
    <div class="bg-white border-b border-gray-200 sticky top-0 z-10 shadow-sm">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 py-4">
            <div class="flex items-center gap-4">
                <button onclick="history.back()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                    <i data-lucide="arrow-left" class="w-6 h-6 text-[#252451]"></i>
                </button>
                <h1 class="text-xl font-bold text-[#252451]">
                    <span th:text="${content.title} + ' 리뷰'"></span>
                </h1>
            </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto px-4 sm:px-6 py-8 space-y-8">
        
        <div class="bg-white rounded-2xl p-6 sm:p-8 shadow-sm border border-gray-100 flex flex-col sm:flex-row items-center gap-8">
            <div class="text-center sm:text-left flex-shrink-0">
                <div class="text-5xl font-extrabold text-primary mb-2" th:text="${averageRating != null ? averageRating : '0.0'}"></div>
                
                <div class="flex items-center justify-center sm:justify-start gap-1 mb-2">
                    <th:block th:each="num : ${#numbers.sequence(1, 5)}">
                        <i th:if="${averageRating ge num}" 
                           data-lucide="star" class="w-6 h-6 fill-yellow-400 text-yellow-400"></i>
                        <i th:if="${averageRating lt num and averageRating ge (num - 0.5)}" 
                           data-lucide="star-half" class="w-6 h-6 fill-yellow-400 text-yellow-400"></i>
                        <i th:if="${averageRating lt (num - 0.5)}" 
                           data-lucide="star" class="w-6 h-6 fill-gray-200 text-gray-200"></i>
                    </th:block>
                </div>
                
                <p class="text-gray-500 text-sm font-medium" th:text="'총 ' + ${totalReviews != null ? totalReviews : 0} + '개의 리뷰'"></p>
            </div>
            
            <div class="flex-grow w-full space-y-2">
                <div th:each="starNum : ${#numbers.sequence(5, 1, -1)}" class="flex items-center gap-3 text-sm">
                    <span class="w-3 font-medium text-gray-700" th:text="${starNum}">5</span> 
                    <div class="flex-grow h-2 bg-gray-100 rounded-full overflow-hidden">
                        <div class="h-full bg-primary" 
                             th:style="'width: ' + (${ratingPercentages != null ? ratingPercentages[starNum] : 0}) + '%'"
                             th:classappend="${starNum == 4 ? 'opacity-80' : (starNum == 3 ? 'opacity-60' : (starNum == 2 ? 'opacity-40' : (starNum == 1 ? 'opacity-20' : '')))}"></div>
                    </div> 
                    <span class="w-8 text-right text-gray-500" th:text="${ratingCounts != null ? ratingCounts[starNum] : 0}"></span>
                </div>
            </div>
        </div>

        <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
            <select id="sort-select" th:data-content-id="${content.id}" class="px-4 py-2 bg-white border border-gray-200 rounded-lg text-gray-700 focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary w-full sm:w-auto font-medium">
                <option value="latest" th:selected="${currentSort == 'latest'}">최신순</option>
                <option value="high" th:selected="${currentSort == 'high'}">별점 높은 순</option>
                <option value="low" th:selected="${currentSort == 'low'}">별점 낮은 순</option>
            </select>
            
            <div class="flex gap-2 w-full sm:w-auto">
                <a th:href="@{|/reservation/detail/${content.id}/reviews?sort=${currentSort != null ? currentSort : 'latest'}&photoOnly=false|}" 
                   th:class="${photoOnly == true} ? 'px-4 py-2 bg-white border border-gray-200 text-gray-600 rounded-full text-sm font-medium hover:bg-gray-50 transition-colors w-full sm:w-auto text-center' : 'px-4 py-2 bg-primary border border-primary text-white rounded-full text-sm font-medium shadow-sm transition-colors w-full sm:w-auto text-center'">전체</a>
                
                <a th:href="@{|/reservation/detail/${content.id}/reviews?sort=${currentSort != null ? currentSort : 'latest'}&photoOnly=true|}" 
                   th:class="${photoOnly == true} ? 'px-4 py-2 bg-primary border border-primary text-white rounded-full text-sm font-medium shadow-sm transition-colors w-full sm:w-auto text-center' : 'px-4 py-2 bg-white border border-gray-200 text-gray-600 rounded-full text-sm font-medium hover:bg-gray-50 transition-colors w-full sm:w-auto text-center'">포토 리뷰만</a>
            </div>
        </div>

        <div class="space-y-4 pb-24" id="review-list-container">
            
            <div th:if="${#lists.isEmpty(paging.content)}" class="text-center py-12 bg-white rounded-2xl border border-gray-100 shadow-sm">
                <p class="text-gray-500">아직 작성된 관람평이 없습니다. 첫 리뷰의 주인공이 되어보세요!</p>
            </div>

            <div th:each="review : ${paging.content}" class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-[#503396] to-[#252451] flex items-center justify-center text-white font-medium"
                             th:text="${review.user != null and review.user.name != null ? #strings.substring(review.user.name, 0, 1) : '익'}">김</div>
                        <div>
                            <div class="font-bold text-gray-900" th:text="${review.user != null and review.user.name != null ? #strings.substring(review.user.name, 0, 1) + '**' : '알수없음'}">김**</div>
                            
                            <div class="flex gap-0.5 mt-0.5">
                                <i th:each="num : ${#numbers.sequence(1, 5)}" 
                                   data-lucide="star" class="w-3.5 h-3.5"
                                   th:classappend="${num <= review.rating ? 'fill-yellow-400 text-yellow-400' : 'fill-gray-200 text-gray-200'}">
                                </i>
                            </div>
                        </div>
                    </div>
                    <span class="text-sm text-gray-400 font-medium" th:text="${#temporals.format(review.createdAt, 'yyyy.MM.dd')}">2026.02.20</span>
                </div>
                
                <div th:if="${review.spoiler}" class="relative w-full py-6 bg-gray-50 flex flex-col items-center justify-center rounded-lg cursor-pointer border border-gray-200 hover:bg-gray-100 transition-colors mb-4"
                     onclick="this.classList.add('hidden'); this.nextElementSibling.classList.remove('hidden')">
                    <i data-lucide="eye-off" class="w-6 h-6 text-gray-400 mb-2"></i>
                    <span class="text-sm font-bold text-gray-600">스포일러가 포함된 리뷰입니다.</span>
                    <span class="text-xs text-gray-400 mt-1">클릭해서 내용 보기</span>
                </div>

                <div th:classappend="${review.spoiler} ? 'hidden' : ''" class="w-full">
                    <p class="text-gray-700 leading-relaxed mb-4 whitespace-pre-line" th:text="${review.text}">리뷰 내용</p>
                    
                    <div th:if="${review.photoUrls != null and review.photoUrls != ''}" class="flex gap-2 flex-wrap mt-3">
                        <div th:each="photo : ${#strings.arraySplit(review.photoUrls, ',')}">
                            <img th:src="@{|/upload/review/${photo}|}" 
                                 alt="리뷰 이미지" 
                                 class="w-24 h-24 sm:w-32 sm:h-32 object-cover rounded-lg border border-gray-200 shadow-sm hover:opacity-90 transition-opacity cursor-pointer">
                        </div>
                    </div>
                </div>
                
            </div> 
            
            <div th:if="${!paging.isEmpty()}" class="flex justify-center mt-8 gap-2 font-medium">
                <a th:if="${paging.hasPrevious()}" th:href="@{|/reservation/detail/${content.id}/reviews?page=${paging.number - 1}&sort=${currentSort != null ? currentSort : 'latest'}&photoOnly=${photoOnly == true}|}" 
                   class="px-4 py-2 border border-gray-200 rounded-lg hover:bg-gray-50 text-gray-600 transition-colors">이전</a>
                
                <a th:if="${paging.hasNext()}" th:href="@{|/reservation/detail/${content.id}/reviews?page=${paging.number + 1}&sort=${currentSort != null ? currentSort : 'latest'}&photoOnly=${photoOnly == true}|}" 
                   class="px-4 py-2 border border-gray-200 rounded-lg hover:bg-gray-50 text-gray-600 transition-colors">다음</a>
            </div>

        </div>
    </div>

    <a th:href="@{|/reservation/detail/${content.id}/review/write|}" 
       class="fixed bottom-8 right-8 px-6 py-4 rounded-full text-white font-bold shadow-lg hover:shadow-xl hover:scale-105 transition-all flex items-center gap-2 group bg-primary z-50">
        <i data-lucide="pen-line" class="w-5 h-5 group-hover:rotate-12 transition-transform"></i>
        <span>리뷰 작성하기</span>
    </a>

    <div th:replace="~{layout/footer::footer}"></div>
    <script>lucide.createIcons();</script>
</body>
</html>